---
title: "Linux를 2주 내내 사용해보고 느낀 소감."
layout: post
tags: [Linux everyday, QEMU]
---

### 들어가며

2주 내내 미친 듯이 Linux를 사용했다. 그러다가 갑작스럽게 급한 일이 터져서 일을 하고보니 MacOS에 와 있었다.

2주동안 급하게 해달라는 일이 생길 때마다 MacOS로 왔었다. Windows도 아니고 Linux도 아니다. 

힘들 때 도와주는 사람이 진짜 이웃이고 진짜 친구다 라는 말이 있지 않은가? 나한테 그런 존재는 MacOS가 되었다.

생각해보면 한 땐 그게 Windows였던 때가 있었다. MacOS로 옮겨오면서 급한 일이 생기면 모두 Windows로 가서 해결했는데, 어느 덧 나에겐 MacOS가 가장 편한 OS가 되었다.

사실 2주 동안 미친 듯이 Linux를 사용한 것은 예전에도 그랬던 적이 없었으니 2주 동안 미친 듯 빠져들면 아예 이쪽으로 넘어가든가 아니면 다신 뒤도 돌아보지 않겠지 했던 것 같다. 

### 2주동안 리눅스로 뭘 했나?

#### 기존 소프트웨어/업무의 해결 가능여부를 확인

처음엔 기존의 Mac이나 Windows에서 하던 일을 Linux에서 했던 것 같다. MacOS에서 Docker를 불러서 하던 일을 Linux에서 했고 (그래도 docker를 써야 된다 워낙 이쪽도 계보가 복잡해서).

초기에 느낀 점은
- Linux에서는 benchmark 점수도 워낙에 잘나오고, 뭘 해도 가볍고 쓸데 없는 짓을 하지 않아서 엄청나게 쾌적하다. 쓸데없이 너무 고사양 컴퓨터를 쓰고 있는 듯한 느낌까지 받는다. 
- 기존에 Windows/Mac에서 하던 일을 대부분 비슷하겐 다 해낸다. 그런데 아쉬운 것들이 많이 보인다. OS 때문이 아니라 소프트웨어가 이쪽으로 개발되어있지 않아서다.
- Docker는 친정에서 일을 하는 것과 같으니까 뭘 하든 엄청나게 빨랐다. MacOS에서 불러쓰는 Docker에 비할 게 아니었다.

답답한 일은 '꼭' 써야만 하는 소프트웨어들 때문에 발생한다.
- MS Word/Visio/...
- FinalCut/Logic/iTunes/...
- 윈도우즈용 고사양 게임

리눅스에서는 대체품이 있긴 하지만, 완벽하게 모든 기능을 다 대체하진 못한다. 또 억지로 쓰려고 하면 엄청나게 많은 노동과 괴로움을 발생시킨다. 2주 동안에 신물나게 경험했다.

그래서, 결론은 리눅스 상에서의 남아도는 능력을 가상 OS로 쏟아줌으로써 리눅스를 base로 사용하되 나머지 OS들을 객으로 불러쓰자 였다. 이게 충분히 가능할 정도로 좋아보였다.

#### 가상머신, QEMU, GPU passthrough

QEMU로 윈도우즈나 MacOS의 가상머신이 떠오르는 것을 보는 것은 생각보다 어렵지 않다. MacOS는 어느 정도 노동이 들어가야 되지만 Virt Manager라는 좋은 소프트웨어 덕택에 GUI 수준에서 대부분 쉽게 해결된다. 그런데, 우리의 목적은 Windows나 MacOS가 guest OS로 떠오르는 것을 보자는 것이 아니라 이것들을 아주 쾌적하게 사용할 수 있어야 한다는 것이다. 

여기서 문제가 발생한다. host PC가 아무리 빨라도 guest를 host처럼 돌릴 수는 없다. 
이상스럽게도 키감과 마우스감, 특히 그래픽에서 뭔가 밀리고 답답한 느낌을 받게 된다. 좋다는 방법을 다 사용해봐도 뭔가 아쉽고 답답하게만 느껴진다. GPU의 기능은 특히나 그러하다. 그러니까 guest os가 youtube를 본다거나 하면 이게 매끄럽게 돌아가는 경우는 없다. guess OS가 host와 GPU를 공유하는 경우는 (엄밀히 말해서 guess OS가 가상의 frame buffer에 데이터를 쓰고 host OS가 그것을 자신의 GPU의 frame buffer에 뿌리는 것임) GPU의 가속기능을 제대로 사용할 수 없기 때문이다.

윈도우즈는 게임을 하는 경우가 아니라면 가속기능을 생각보다 별로 사용하지 않아서 마우스와 키감의 답답해짐만 극복하면 쓸만한 수준이 되지만, MacOS는 QE/CI라고 해서 OS의 GUI에 특화되어있는 가속기능이 제대로 돌지 못해서 엄청나게 뻑뻑해질 때가 발생한다. 그런 것들을 경험해보면 GPU passthrough라고 해서 guest OS에게 GPU자원을 아예 dedicated resource로 만들어주는 방법을 생각해보게 된다. 실제로 많은 이들이 이렇게 쓰고 있는 듯 하다. 

이게 생각보다 쉽지 않다. 나는 2주의 대부분을 QEMU에서 GPU passthrough를 하는 것과 Intel GPU의 GVT-g라는 기능을 실험해보는데 다 허비했다. 

결론은? 그래도 natiave하게 쓰는 것과는 차이가 많다 라는 것이다. 아마도 마우스와 카보드를 USB controller를 PCI passthrough하게 되면 이 불만은 해소될 것 같은데, 이것도 또한 쉬운 일이 아니다. 더구나 난 single GPU로 했기 때문에 사실상 난이도가 배 이상이 되었다. 

#### Single GPU passthrough

이것은 말 그대로 GPU한 개로 passthrough한다는 것이다. 즉 guest OS가 떠오를 때 host OS로부터 GPU를 분리해서 guest로 넘겨주고, guest OS가 들어가면 host에게 다시 돌려주는 일을 하는 것이다. 생각은 매우 간단하다. 그런데 잘 안된다. PCI 장치를 linux kernel 상에서 분리했다가 다시 붙이고 하는 게 script를 써서 자동화를 해도 잘 안된다. 내 경우는 분리된 GPU가 guest OS에서 인식이 제대로 안되서 많은 삽질을 했다. 무슨 말이냐면 standard VGA 상태로 사용될 땐 잘 되다가 윈도우즈가 해당 GPU에 대한 드라이버를 설치하면서 문제가 발생했다. 결국 GPU 자신의 드라이버가 제대로 설치되지 않으면 passthrough는 하나마나한 결과를 초래한다. 

또 이 작업이 한꺼번에 성공적으로 일어나지 않으면 그냥 화면이 먹통이 되어버리고 외부에서 되살려주어야 하는 상황이 펼쳐지니까 정신건강상 할게 못된다. 정 해보고 싶다면 싸구려 GPU 카드라도 하나 더 사서 달고 쓰는 것을 권장한다. 나도 물론 같은 생각을 했는데, 막상 싸구려를 사자니 마땅한 게 없고 이 코로나 시국에 주문해서 받게 되는 데까지 많은 시간이 걸리고 어차피 90% 이상의 사용시간동안 GPU 하나는 그냥 놀게 될 것이니까 그냥 접게 되었다. 지금 생각하면 잘한 일 같다.

#### Another caveat

GPU passthrough는 MacOS에서는 잘 동작했다. 여기서 문제는 keyboard와 mouse 그리고 audio card를 넘기는 데서 발생했다. 이야기하자면 좀 복잡하지만 PCI로 passthrough를 하게 되면 IOMMU라는 group에 속해있는 device들이 전부 영향을 받는데, USB controller와 GPU는 별 개의 IOMMU에 있고 USB controller가 속해있는 IOMMU는 굵직한 것들 (대개 칩셋 기능)이 같이 들어있어서 passthrough하기가 만만치 않은 것들이다. 

윈도우즈에서는 생각보다 audio의 전달은 용이한 반면 내 경우 두 가지 모두 GPU를 통한 audio passthrough도 제대로 되지 않아서 시간만 허비하고 결국 포기했다. 

대부분 기능이 제대로 동작하지 않는 부분, 또는 설치 과정 중에서 일부러 뛰어넘어간 부분이 내내 말썽이 되어 시간을 소비했다. 사실 이런 기능들은 가상 OS를 위해서 제공되고 있는 기능들인데 일반 사용자들이 별로 사용할 일이 없어서 알려지지도 않고 실제로 사용하는 사람들의 수도 작아서 그 경험이 많이 공유되지 않고 있다는 것이 또 문제가 된다. 그래서 기능이 제공된다고는 하는데, 진짜로 그 기능이 제대로 동작하는지 해본 사람이 별로 없고 해봤더라도 어떤 어떤 조건에서 해봤는데 되었다라든가 하는 것들이 없는 것이다. 

### 결론

Linux는 요즘의 배포판들이 대부분 필요한 기능들을 필요에 따라 설치해서 쓰는 모양새로 바뀌고 그럼에 따라 OS는 쓸데 없는 일을 하지 않는 덕택에 오직 일을 하기 위해 태어난 OS다 싶다. 더구나 Docker를 쓰면 배포판에 구애받지 않고 특정 배포판에 특화된 거의 모든 소프트웨어들을 아주 쉽고 간단하게, 또 성능 저하가 전혀 없이 사용할 수 있고, 작업별로 컨테이너를 꾸며서 관리하면 되니까, 하나의 배포판을 가지고 여러 가지 작업 환경에 맞추느라 지저분하게 되는 일을 볼 일도 없어졌다. 그렇게 Linux만을 3-4일 사용해보고 얻은 결론은 Linux를 헤드리스 OS 상태로 놔두고 이것을 호스트 OS로 하여 그 위에서 QEMU로 Windows나 MacOS를 사실상의 main OS로 사용함으로써 재부팅하지 않아도 되고, 또 (가상 네트워크 파일 시스템을 쓰게 하여) 사실상 모두 같은 파일 시스템을 쓰게끔 함으로써 관리를 편하게 할 수도 있겠다 는 것이었다. 

QEMU가 Linux 위에서는 정말 엄청나게 빠르게 잘 돌아가는데다 리눅스 자체가 소비하는 시스템부하가 거의 없어서 이런 일은 정말 쉽게 해낼 수 있겠구나 싶었으나, 그것은 어디까지나 CPU 성능에 관여된 것들일 뿐, 큰 문제는 각각의 가상 OS에 연결되는 인터페이스 장치들이 호스트를 경유해서 지나가게 되어있고 더러는 공유를 해야하는 과정에서 사용감이 크게 떨어진다는 것이었다. 이것을 해결하는 방법으로 host의 커널에서 PCI 장치를 guess OS로 넘겨주는 pci passthru라는 기능을 이용해서 GPU를 별도로 사용하는 방법을 쓸 수 있다. 그러나 USB 장치들은 이게 생각보다 쉽게 할 수 없고 역시나 별도의 USB card를 구입해서 붙여주어야 하는 문제가 발생했다. 요새 PC들은 작은 폼펙터로 나오기 때문에 PCIe slot의 그다지 여유가 없어서 이런 일을 하기가 만만치가 않았다. 

어쨌든 결론은 지금의 가상 OS 환경에서는 공유해야 하는 하드웨어 자원을 편리하게 passthrough 하기가 만만찮아서 linux를 host OS로 해서 그 위에 모든 OS들을 묶는 일이 쉽지는 않았다는 것이고, 억울하지만 여러 개의 OS를 굴리면서 여러 개의 filesystem을 사용해야 하고 이 과정에서 여러 가지 불편사항들은 예나 지금이나 큰 차이가 없다는 것을 알게 되었다. 