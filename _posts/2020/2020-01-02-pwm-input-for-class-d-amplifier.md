---
title: "class D amplifier에 PWM 입력이 주어지면 어떨까?"
layout: post
tags: [pwn, class d]
---

디지털 회로에서 아날로그 신호를 다루는 일은 좀 귀찮은 일이다. 아날로그 신호 그 자체를 있는 그대로 다룬다고 치면 이미 그 정확도가 정해져있으니까 정수로 취급하면 되니까 여기까진 좀 편하지만, 만일 내부에서 아날로그 신호를 만들어내고 정확도를 끌어올려야 된다고 치면 부동소수점 신호르 취급해야 되고 저장이나 처리에 많은 메모리를 들여야되니까 여기서부터는 부담스러운 일이 된다. 

그런데, 처리하는 빈도를 매우 매우 높여서 0과 1로 처리하면 문제가 좀 쉬워지게 된다. 사실 이것은 정해진 길이의 정수로 표현된 아날로그 신호를 0과 1로 직렬화 (serialize)해 버린 것이나 다름 없으니까 그게 그거라고 볼 수도 있지만 매 순간 처리해야 되는 정보의 양이 줄어들고 디지털 (0과 1)의 본질에 가까운 신호이기 때문에 그러하다. 더구나, 저가 기기들은 16비트 정수 같은 것을 (외부로) 내보내려고 한다고 치면 17개의 핀 (gnd 포함)을 필요로 하고 그 각각이 wire가 되니까 제작하기 귀찮아지는 문제가 발생한다. 만일 직렬로 전송한다고 치면 sync 같은 것을 맞춰야 되니까 귀찮은 일이 된다.

그런데, 아예 이런 것과 상관없이 내보낼 수 있다고 하면 아주 값싸게 만들어버릴 수가 있는 것이다. 그러니까 GPIO pin 한개에 오디오 채널 하나를 할당할 수 있는 것이다. 이거 매우 그럴싸하지 않는가? 물론 샘플링 주파수는 올릴 수 밖에 없다. 대략 5-6배 정도로 올려주는 것은 요새처럼 빠른 컴퓨터시대에서는 일도 아니니까. 

이 때 이 PWM 출력을 다시 아날로그 출력으로 회복하려면 low pass filtering이 필요하다. 그러니까 (L)-R-C로 된 회로를 밖에 꾸며넣어야 한다는 건데 이게 참 귀찮은 일이다. 그냥 이 신호를 class D amplifier에 넣어버리면 안될까? 어차피 class d amplfier는 PWM 신호를 사용하니까 말이다.

일단 수식을 작성해보자. Jekyll에서 이게 제대로 나올지는 모르겠다만.

PWM 신호는 일반적으로 톱니파 (saw wave)와 입력의 진폭을 비교하여 그 결과를 이용하게 된다. 그러니까 saw wave generator 출력과 아날로그 입력을 comparator에 먹여서 그 결과를 얻는 것이다.

수식으로 전개하면 

$$ x_{PWM} (t) = {\rm sgn} ( x(t) - \sum_n s(nT_s)), $$

여기서, 톱니파 $s(t) = t$ 이다. 즉, 톱니파의 무한한 대열에 대해서 비교 결과를 얻게 되는 것이다. 대충 이것을 주파수 영역에서 해석해보면 입력 신호 x(t)의 주파수 응답을 $1/T_s$ 주파수 간격으로 벌려놓은 것과 같은 결과를 얻게 된다. 톱니파도 어찌보면 일반적인 impulse ($\delta (t)$)의 무한열과 유사하다고 볼 수 있으니까.

여기서 입력 x(t)를 또 다른 PWM 신호라고 치면, 여전히 PWM 신호가 주파수 영역에 좌우로 $1/T_s$ 간격 만큼 벌려있는 것이라고 볼 수 있다. 

이 때 문제는 입력의 톱니파 주기와 이것을 변환할 때의 톱니파 주기의 관계이다. 중요한 것은 LPF를 통해서 원래 신호를 회복시킬 수 있는 조건이 되느냐 아니냐인데, 입력의 톱니파 주기도 입력 아날로그 신호의 최대 주파수보다 충분히 높고 변환시의 톱니파 주기도 충분히 높은 지경이라면 별다른 문제가 없다고 볼 수 있다. 

즉, $T_2 \le T_1$라고 하면 아래와 같은 관계가 성립된다고 볼 수 있다.

$$ x_{PWM^2} (t) = {\rm sgn} ( x_{PWM} (t) - \sum_n s(nT_1)) \\ = {\rm sgn} ( {\rm sgn} ( x (t) - \sum_n s(nT_2)) - \sum_n s(nT_1))\\ 
= {\rm sgn} ( x (t) - \sum_n s(nT_2)), $$

문제는 톱니파와 PWM 입력의 전압관계인데 PWM입력이 0-3.3V를 오간다고 하고 PWM입력은 이를테면 (-1.0, +1.0) 구간을 스윙한다고 보면, 여기서 위상차가 발생할 수 있으니까 이것은 문제가 될 수 있다. 예를 들어 단순히 아주 작은 C를 하나 붙여서 DC를 제거하는 방법으로 하면 큰 왜곡없이도 전달이 가능하지 않을까 생각해볼 수 있다.

왜 이런 일을 하느냐? Raspberry pi zero W에 airplay speaker를 하나 만들어보기 위해서다. 기왕이면 bluetooth receiver도 활용해서 upnp + airplay + bluetooth speaker를 만들어보는 것인데, raspberry pi zero W는 별도의 audio단자가 없어서 PWM 출력만을 얻을 수 있다.

추후 실험해보고 결과를 적어보기로 하겠다. 